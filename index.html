<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.15.1/dist/numjs.min.js"></script>
    <script src="./pkg/numrs.js"></script>
    <meta charset="utf-8">
    <title>hello-wasm example</title>
</head>

<body>
    <script type="module">
        //import init, { ArrayNDJSJS.new, ArrayNDJSJS.new2d, ArrayNDJSJS.new3d, ArrayNDJS } from "./pkg/numrs.js";
        //import { ArrayNDJSJS.new_js_wrap } from "./pkg/numrs.js"

        import init, { ArrayNDJS } from "./pkg/numrs.js";
        function generate_array_random_numbers(n) {
            let arr = []
            for (let i = 0; i < n; i++) {
                arr.push(Math.random())
            }
            return arr;
        }

        function generate_array2d_random_numbers(shape=[100, 100]) {
            let arr = []
            console.log(shape)
            for (let i = 0; i < shape[0]; i++) {
                let innerArr = []
                for (let j = 0; j < shape[1]; j++) {
                    innerArr.push(Math.random())
                }
                arr.push(innerArr)
            }
            return arr;
        }

        init()
            .then(() => {
                console.log("hello")
                const myBigInt = BigInt(0)
                console.log("myBigInt", myBigInt)

                function get_sum(array) {
                    return array.reduce((a, b) => a + b)
                }
                
                function get_sum2d(array) {
                    let total = 0
                    for (let i = 0; i < array.length; i++) {
                        total += get_sum(array[i])
                    }
                    return total
                }

                // test to_string method

                let arr_ArrayNDJS = ArrayNDJS.new([1,2,3,4,5])
                console.log("ArrayNDJS", arr_ArrayNDJS.toString())

                let arrStr = ArrayNDJS.new([1, 2, 3, 4, 5])
                console.log(arrStr.cos().sin().abs().toString())
                console.log(arrStr.toString())

                // test add

                let arr_ArrayNDJS_2 = ArrayNDJS.new([1, 2, 3, 4, 5])
                console.log(arr_ArrayNDJS_2.add(3).toString())
                console.log(arr_ArrayNDJS_2.add([1, 2, 3, 4, 5]).toString())
                console.log(ArrayNDJS.new([1, 2, 3, 4, 5]).to_vec())

                // generate random number arrays

                let s = Date.now();
                let arr1 = generate_array_random_numbers(1_000_000)
                let e = Date.now();
                console.log("generate random 1st time", e - s)

                let s3 = Date.now();
                let arr3 = generate_array_random_numbers(1_000_000)
                arr3 = ArrayNDJS.new(arr3)
                let e3 = Date.now();
                console.log("generate random 2nd time", e3 - s3)

                let s2 = Date.now();
                let arr2 = ArrayNDJS.random([1_000_000])
                let e2 = Date.now();
                console.log("generate random numrs", e2 - s2)

                console.log("ArrayNDJS random", ArrayNDJS.random([2, 2, 2, 2]).toString())
                // benchmark summing of arrays

                // benchmark 1d array

                s = Date.now();
                //let array = [...Array(100_000_000).keys()]
                let array = generate_array_random_numbers(10_000)
                let numrs_arr = ArrayNDJS.new(array)
                let njarr = nj.array(array, "float64")
                let iterations = 10_000

                // numrs sum
                console.log("\nnumrs sum")

                let array_sum_wasm = numrs_arr.sum()
                s = Date.now();
                for (let i = 0; i < iterations; i++) {
                    array_sum_wasm = numrs_arr.sum()
                }
                console.log(`wasm time taken ${Date.now() - s}ms`)
                console.log("array_sum_wasm", array_sum_wasm)
                
                s = Date.now();
                for (let i = 0; i < iterations; i++) {
                    array_sum_wasm = numrs_arr.sum()
                }
                console.log(`wasm time taken ${Date.now() - s}ms`)
                console.log("array_sum_wasm", array_sum_wasm)

                // numjs sum
                console.log("\nnumjs sum")

                let array_sum = njarr.sum()
                s = Date.now();
                for (let i = 0; i < iterations; i++) {
                    array_sum = njarr.sum()
                }
                console.log(`numjs time taken ${Date.now() - s}ms`)
                console.log("numjs array sum", array_sum)

                s = Date.now();
                for (let i = 0; i < iterations; i++) {
                    array_sum = njarr.sum()
                }
                console.log(`numjs time taken ${Date.now() - s}ms`)
                console.log("numjs array sum", array_sum)

                // naive sum
                console.log("\nnaive sum")

                let array_sum2 = get_sum(array)
                s = Date.now();
                for (let i = 0; i < iterations; i++) {
                    array_sum2 = get_sum(array)
                }
                console.log(`js time taken ${Date.now() - s}ms`)
                console.log("naive array sum", array_sum2)

                s = Date.now();
                for (let i = 0; i < iterations; i++) {
                    array_sum2 = get_sum(array)
               }
                console.log(`js time taken ${Date.now() - s}ms`)
                console.log("naive array sum", array_sum2)



                // benchmark 2d array

                s = Date.now();
                array = generate_array2d_random_numbers()
                numrs_arr = ArrayNDJS.new(array)
                njarr = nj.array(array, "float64")
                iterations = 10_000

                // numrs sum
                console.log("\nnumrs sum")

                array_sum_wasm = numrs_arr.sum()
                s = Date.now();
                for (let i = 0; i < iterations; i++) {
                    array_sum_wasm = numrs_arr.sum()
                }
                console.log(`wasm time taken ${Date.now() - s}ms`)
                console.log("array_sum_wasm", array_sum_wasm)
                
                s = Date.now();
                for (let i = 0; i < iterations; i++) {
                    array_sum_wasm = numrs_arr.sum()
                }
                console.log(`wasm time taken ${Date.now() - s}ms`)
                console.log("array_sum_wasm", array_sum_wasm)

                // numjs sum
                console.log("\nnumjs sum")

                array_sum = njarr.sum()
                s = Date.now();
                for (let i = 0; i < iterations; i++) {
                    array_sum = njarr.sum()
                }
                console.log(`numjs time taken ${Date.now() - s}ms`)
                console.log("numjs array sum", array_sum)

                s = Date.now();
                for (let i = 0; i < iterations; i++) {
                    array_sum = njarr.sum()
                }
                console.log(`numjs time taken ${Date.now() - s}ms`)
                console.log("numjs array sum", array_sum)

                // naive sum
                console.log("\nnaive sum")

                array_sum2 = get_sum(array)
                s = Date.now();
                for (let i = 0; i < iterations; i++) {
                    array_sum2 = get_sum2d(array)
                }
                console.log(`js time taken ${Date.now() - s}ms`)
                console.log("naive array sum", array_sum2)

                s = Date.now();
                for (let i = 0; i < iterations; i++) {
                    array_sum2 = get_sum2d(array)
               }
                console.log(`js time taken ${Date.now() - s}ms`)
                console.log("naive array sum", array_sum2)
            });
    </script>
</body>

</html>